<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MapboxThree - Performance Optimization Examples</title>
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css' rel='stylesheet' />
    <script src="https://unpkg.com/three@0.158.0/build/three.js"></script>
    <style>
        body { margin: 0; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
        #controls {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            z-index: 1;
            min-width: 180px;
            max-width: 200px;
            font-family: Arial, sans-serif;
            font-size: 12px;
        }
        .control-group {
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid #eee;
        }
        .control-group:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        .control-group h3 {
            margin: 0 0 5px 0;
            color: #333;
            font-size: 12px;
            font-weight: bold;
        }
        .button-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 4px;
            margin-bottom: 4px;
        }
        button {
            margin: 0;
            padding: 6px 8px;
            background: #4a90e2;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
            transition: all 0.2s ease;
        }
        button:hover {
            background: #357abd;
        }
        button.active {
            background: #2ecc71;
        }
        button.warning {
            background: #e74c3c;
        }
        button.warning:hover {
            background: #c0392b;
        }
        #stats {
            font-family: monospace;
            font-size: 11px;
            line-height: 1.4;
            margin-top: 5px;
            padding: 5px;
            background: #f8f9fa;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div id="controls">
        <div class="control-group">
            <h3>点云数据</h3>
            <div class="button-grid">
                <button onclick="window.addPoints(1000)">1千点</button>
                <button onclick="window.addPoints(5000)">5千点</button>
                <button onclick="window.addPoints(10000)">1万点</button>
                <button onclick="window.addPoints(50000)">5万点</button>
            </div>
            <button class="warning" onclick="window.clearAllPoints()">清除</button>
        </div>
        <div class="control-group">
            <h3>性能优化</h3>
            <button id="batchingBtn" onclick="window.toggleBatching()">批量渲染: 开</button>
            <button id="lodBtn" onclick="window.toggleLOD()">LOD: 开</button>
            <button id="poolBtn" onclick="window.toggleObjectPool()">对象池: 开</button>
        </div>
        <div class="control-group">
            <h3>性能监控</h3>
            <div id="stats"></div>
        </div>
        <div class="control-group">
            <h3>渲染性能</h3>
            <div id="renderTime" class="stats"></div>
        </div>
    </div>

    <script type="module">
        import { MapboxThree } from '../src/core/index.ts';
        import { ObjectPool } from '../src/utils/ObjectPool.ts';
        import { BatchManager } from '../src/utils/BatchManager.ts';
        import * as THREE from 'three';

        let mapboxThree;
        let currentObjects = [];
        let batchingEnabled = true;
        let lodEnabled = true;
        let objectPoolEnabled = true;

        // 初始化 MapboxThree
        async function initializeMapboxThree() {
            const performanceConfig = {
                batchingEnabled: true,
                lodLevels: {
                    near: { distance: 1000, detail: 1 },
                    medium: { distance: 2000, detail: 0.5 },
                    far: { distance: 5000, detail: 0.25 }
                },
                eventThrottling: true,
                throttleDelay: 16,
                poolEnabled: true,
                poolTypes: ['sphere'],
                maxObjectsInPool: 1000000
            };

            mapboxThree = new MapboxThree({
                mapboxConfig: {
                    container: 'map',
                    style: 'mapbox://styles/mapbox/dark-v11',
                    accessToken: 'pk.eyJ1IjoiYmVzdHljdyIsImEiOiJjbTRnb2VidWoxaHlwMmtzOHdyZW10aHVrIn0.-tjZrZdnvvBeL_tZKamSKw',
                    center: [-74.5, 40],
                    zoom: 14,  // 更近的视角
                    pitch: 60,
                    bearing: 30
                },
                defaultLights: true,
                performanceConfig: performanceConfig,
                onLoad: () => {
                    console.log('MapboxThree initialized');
                    // 初始化完成后添加示例点云
                    setTimeout(() => {
                        window.addPoints(1000);
                    }, 1000);
                }
            });
        }

        // 生成随机点云数据
        function generatePointCloudData(count, centerLng, centerLat, radius) {
            const points = [];
            for (let i = 0; i < count; i++) {
                const angle = Math.random() * Math.PI * 2;
                const r = Math.pow(Math.random(), 0.5) * radius;
                const lng = centerLng + (r * Math.cos(angle));
                const lat = centerLat + (r * Math.sin(angle));
                
                // 使用更鲜艳的颜色
                const hue = Math.random();
                const saturation = 1.0;  // 最大饱和度
                const lightness = 0.5;   // 适中的亮度
                const color = new THREE.Color().setHSL(hue, saturation, lightness);
                
                points.push({
                    coordinates: [lng, lat],
                    altitude: 50 + Math.random() * 200,  // 降低高度范围
                    radius: 1 ,     // 增大点的大小
                    color: color
                });
            }
            return points;
        }

        // 更新按钮状态
        function updateButtonState(id, enabled) {
            const btn = document.getElementById(id);
            if (btn) {
                btn.textContent = `${btn.textContent.split(':')[0]}: ${enabled ? '开' : '关'}`;
                btn.className = enabled ? 'active' : '';
            }
        }

        // 清除所有点
        window.clearAllPoints = () => {
            if (!mapboxThree || currentObjects.length === 0) return;

            // 从场景中移除所有对象
            currentObjects.forEach(obj => {
                mapboxThree.remove(obj);
                if (obj.geometry) obj.geometry.dispose();
                if (obj.material) obj.material.dispose();
            });
            
            // 清空数组
            currentObjects = [];
            console.log('Cleared all points');
        };

        // 添加点云数据
        window.addPoints = async (count) => {
            if (!mapboxThree || !mapboxThree.getMap()) return;
            
            const center = mapboxThree.getMap().getCenter();
            const points = generatePointCloudData(count, center.lng, center.lat, 0.01);
            const newObjects = [];

            // 记录开始时间
            const startTime = performance.now();

            // 批量处理还是单个处理
            if (batchingEnabled) {
                console.log('批量创建');
                // 批量创建
                const batchedObjects = points.map(point => ({
                    coordinates: point.coordinates,
                    radius: point.radius,
                    color: '#' + point.color.getHexString(),
                    opacity: 0.9,
                    units: 'meters',
                    altitude: point.altitude
                }));

                // 使用 Promise.all 批量创建对象
                const spheres = await Promise.all(batchedObjects.map(options => {
                    const sphere = mapboxThree.sphere(options);
                    if (sphere) {
                        mapboxThree.add(sphere);
                        return sphere;
                    }
                }));

                newObjects.push(...spheres.filter(Boolean));
            } else {
                // 逐个创建
                for (const point of points) {
                    const sphere = mapboxThree.sphere({
                        coordinates: point.coordinates,
                        radius: point.radius,
                        color: '#' + point.color.getHexString(),
                        opacity: 0.9,
                        units: 'meters',
                        altitude: point.altitude
                    });

                    if (sphere) {
                        mapboxThree.add(sphere);
                        newObjects.push(sphere);
                    }
                }
            }

            // 记录结束时间
            const endTime = performance.now();
            const renderTime = endTime - startTime;

            currentObjects = currentObjects.concat(newObjects);
            
            // 更新渲染时间显示
            const renderTimeDisplay = document.getElementById('renderTime');
            if (renderTimeDisplay) {
                renderTimeDisplay.innerHTML = `
                    渲染时间: ${renderTime.toFixed(2)}ms<br>
                    每个对象: ${(renderTime / count).toFixed(2)}ms<br>
                    渲染模式: ${batchingEnabled ? '批量' : '单个'}<br>
                    对象数量: ${count}
                `;
            }

            console.log(`Added ${count} points in ${renderTime.toFixed(2)}ms (${(renderTime / count).toFixed(2)}ms per object)`);

            // 调整视角以更好地观察点云
            mapboxThree.getMap().easeTo({
                center: center,
                zoom: 15,
                pitch: 60,
                bearing: 30,
                duration: 1000
            });
        };

        // 性能优化控制
        window.toggleBatching = () => {
            if (!mapboxThree) return;
            batchingEnabled = !batchingEnabled;
            updateButtonState('batchingBtn', batchingEnabled);
            
            const tempObjects = [...currentObjects];
            window.clearAllPoints();
            if (tempObjects.length > 0) {
                window.addPoints(tempObjects.length);
            }
        };

        window.toggleLOD = () => {
            if (!mapboxThree) return;
            lodEnabled = !lodEnabled;
            updateButtonState('lodBtn', lodEnabled);
            currentObjects.forEach(obj => {
                if (obj && typeof obj.setLODEnabled === 'function') {
                    obj.setLODEnabled(lodEnabled);
                }
            });
        };

        window.toggleObjectPool = () => {
            if (!mapboxThree) return;
            objectPoolEnabled = !objectPoolEnabled;
            updateButtonState('poolBtn', objectPoolEnabled);
            
            const count = currentObjects.length;
            window.clearAllPoints();
            if (count > 0) {
                window.addPoints(count);
            }
        };

        // 性能监控
        let frameCount = 0;
        let lastTime = performance.now();
        let lastMemory = 0;

        function updateStats() {
            if (!mapboxThree) return;
            
            const now = performance.now();
            const delta = now - lastTime;
            if (delta >= 1000) {
                const fps = Math.round((frameCount * 1000) / delta);
                const memory = Math.round(performance.memory?.usedJSHeapSize / 1048576 || 0);
                const memoryDiff = memory - lastMemory;
                lastMemory = memory;
                
                const stats = document.getElementById('stats');
                if (stats) {
                    stats.innerHTML = `
                        FPS: ${fps}<br>
                        点数量: ${currentObjects.length.toLocaleString()}<br>
                        内存: ${memory}MB (${memoryDiff >= 0 ? '+' : ''}${memoryDiff}MB)<br>
                        对象数: ${mapboxThree.world?.children.length || 0}
                    `;
                }
                frameCount = 0;
                lastTime = now;
            }
            frameCount++;
            requestAnimationFrame(updateStats);
        }

        // 启动应用
        initializeMapboxThree();
        updateStats();
    </script>
</body>
</html> 