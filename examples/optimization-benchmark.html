<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MapboxThree - 优化性能对比</title>
    <script src='https://api.mapbox.com/mapbox-gl-js/v3.1.2/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v3.1.2/mapbox-gl.css' rel='stylesheet' />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/0.162.0/three.min.js"></script>
    <script src="https://mrdoob.github.io/stats.js/build/stats.min.js"></script>
    <style>
        body { margin: 0; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
        .control-panel {
            position: absolute;
            top: 10px;
            right: 10px;
            background: white;
            padding: 15px;
            border-radius: 4px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            z-index: 1;
            max-width: 300px;
        }
        .section {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        .section:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }
        h3 {
            margin: 0 0 10px 0;
            font-size: 14px;
            color: #333;
        }
        label {
            display: block;
            margin: 5px 0;
            color: #666;
        }
        button {
            display: block;
            width: 100%;
            margin: 5px 0;
            padding: 8px;
            background: #4a90e2;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        button:hover {
            background: #357abd;
        }
        #metrics {
            font-family: monospace;
            font-size: 12px;
            line-height: 1.5;
            background: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
        }
        .stats-panel {
            position: absolute;
            top: 10px;
            left: 10px;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div class="control-panel">
        <div class="section">
            <h3>优化策略</h3>
            <label><input type="checkbox" id="batching" checked> 批处理优化</label>
            <label><input type="checkbox" id="objectPooling" checked> 对象池优化</label>
            <label><input type="checkbox" id="lod" checked> LOD优化</label>
        </div>
        <div class="section">
            <h3>测试场景</h3>
            <button onclick="benchmark.createTestScene(100)">添加100个对象</button>
            <button onclick="benchmark.createTestScene(1000)">添加1000个对象</button>
            <button onclick="benchmark.createTestScene(5000)">添加5000个对象</button>
            <button onclick="benchmark.clearScene()" style="background: #e74c3c">清除场景</button>
        </div>
        <div class="section">
            <h3>性能指标</h3>
            <div id="metrics"></div>
        </div>
    </div>

    <script type="module">
        import { MapboxThree } from '../src/core/index.ts';
        import { OptimizationManager } from '../src/core/OptimizationManager.ts';

        class OptimizationBenchmark {
            constructor() {
                this.objects = [];
                this.isAnimating = false;
                this.initializeMapboxThree();
                this.initializeStats();
            }

            async initializeMapboxThree() {
                this.mapboxThree = new MapboxThree({
                    mapboxConfig: {
                        container: 'map',
                        style: 'mapbox://styles/mapbox/dark-v11',
                        accessToken: 'pk.eyJ1IjoiYmVzdHljdyIsImEiOiJja3Y2YW5icnQxaTltMnBsMGR2c2FmaDZmIn0.bYZIK1mPso12DuyirxXjVw',
                        center: [-74.5, 40],
                        zoom: 15,
                        pitch: 60,
                        bearing: 30,
                        antialias: true
                    },
                    defaultLights: true,
                    onLoad: () => {
                        this.optimizationManager = OptimizationManager.getInstance();
                        this.setupDefaultOptimizations();
                        this.setupEventListeners();
                    }
                });
            }

            initializeStats() {
                this.stats = new Stats();
                this.stats.dom.classList.add('stats-panel');
                document.body.appendChild(this.stats.dom);
            }

            setupDefaultOptimizations() {
                this.optimizationManager.enableStrategy('batching');
                this.optimizationManager.enableStrategy('objectPooling');
                this.optimizationManager.enableStrategy('lod');
            }

            setupEventListeners() {
                ['batching', 'objectPooling', 'lod'].forEach(strategy => {
                    const checkbox = document.getElementById(strategy);
                    checkbox.addEventListener('change', (e) => {
                        if (e.target.checked) {
                            this.optimizationManager.enableStrategy(strategy);
                        } else {
                            this.optimizationManager.disableStrategy(strategy);
                        }
                        this.updateMetricsDisplay();
                    });
                });
            }

            createTestScene(count) {
                this.clearScene();
                const startTime = performance.now();

                // 检查是否启用批处理
                const useBatching = document.getElementById('batching').checked;

                if (useBatching) {
                    // 批处理模式
                    // 1. 先创建所有对象
                    const objects = Array.from({ length: count }, () => this.createRandomObject());
                    
                    // 2. 批量处理
                    objects.forEach(object => {
                        this.optimizationManager.processObject(object);
                    });
                    
                    // 3. 处理所有待处理的批次
                    this.optimizationManager.processBatch();
                    
                    // 4. 添加批处理后的网格
                    const batchMeshes = this.optimizationManager.getBatchMeshes();
                    console.log(batchMeshes);
                    batchMeshes.forEach(mesh => {
                        this.mapboxThree.add(mesh);
                    });
                    
                    // 5. 保存引用
                    this.objects = objects;
                } else {
                    // 不使用批处理，直接添加对象
                    const objects = [];
                    for (let i = 0; i < count; i++) {
                        const object = this.createRandomObject();
                        this.mapboxThree.add(object);
                        objects.push(object);
                    }
                    this.objects = objects;
                }

                const endTime = performance.now();
                console.log(`Created ${count} objects in ${(endTime - startTime).toFixed(2)}ms (Batching: ${useBatching})`);
                
                this.startAnimation();
                this.updateMetricsDisplay();
            }

            clearScene() {
                this.isAnimating = false;
                this.objects.forEach(object => {
                    this.mapboxThree.remove(object);
                });
                this.objects = [];
                this.updateMetricsDisplay();
            }

            createRandomObject() {
                const types = ['sphere', 'box'];
                const type = types[Math.floor(Math.random() * types.length)];
                const position = this.getRandomPosition();

                let object;
                if (type === 'sphere') {
                    object = this.mapboxThree.sphere({
                        coordinates: position,
                        radius: 5,
                        // color: `hsl(${Math.random() * 360}, 70%, 50%)`,
                        opacity: 0.8,
                        units: 'meters',
                        altitude: 100
                    });
                } else {
                    object = this.mapboxThree.box({
                        coordinates: position,
                        width: 10,
                        height: 10,
                        depth: 10,
                        // color: `hsl(${Math.random() * 360}, 70%, 50%)`,
                        opacity: 0.8,
                        units: 'meters',
                        altitude: 100
                    });
                }

                object.userData.geometryType = type;
                object.userData.geometryKey = `${type}-1`;
                // console.log(object);
                // if (!object.geometry) {
                //     console.warn(`No geometry created for ${type}`);
                //     if (type === 'box') {
                //         object.geometry = new THREE.BoxGeometry(1, 1, 1);
                //     } else {
                //         object.geometry = new THREE.SphereGeometry(1, 32, 32);
                //     }
                // }

                return object;
            }

            getRandomPosition() {
                const center = this.mapboxThree.getMap().getCenter();
                const offset = 0.01;
                return [
                    center.lng + (Math.random() - 0.5) * offset,
                    center.lat + (Math.random() - 0.5) * offset
                ];
            }

            updateMetricsDisplay() {
                const metrics = this.optimizationManager.getMetrics();
                const metricsDiv = document.getElementById('metrics');
                if (metricsDiv) {
                    metricsDiv.innerHTML = `
                        <div>对象数量: ${this.objects.length}</div>
                        <div>批次数量: ${metrics.batchCount}</div>
                        <div>内存使用: ${(metrics.memoryUsage / 1024 / 1024).toFixed(2)} MB</div>
                        <div>处理时间: ${metrics.processTime.toFixed(2)} ms</div>
                        <div>对象池大小: ${metrics.poolSize}</div>
                    `;
                }
            }

            startAnimation() {
                if (this.isAnimating) return;
                this.isAnimating = true;
                
                const animate = () => {
                    if (!this.isAnimating) return;
                    
                    this.stats.begin();
                    
                    // this.objects.forEach(object => {
                    //     object.rotation.x += 0.01;
                    //     object.rotation.y += 0.01;
                    // });
                    
                    this.stats.end();
                    this.updateMetricsDisplay();
                    requestAnimationFrame(animate);
                };
                
                animate();
            }
        }

        window.benchmark = new OptimizationBenchmark();
    </script>
</body>
</html> 