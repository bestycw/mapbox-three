<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MapboxThree Basic Example</title>
    <script src='https://api.mapbox.com/mapbox-gl-js/v3.1.2/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v3.1.2/mapbox-gl.css' rel='stylesheet' />
    <style>
        body { margin: 0; }
        #map { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        .control-panel {
            position: absolute;
            top: 10px;
            right: 10px;
            background: white;
            padding: 10px;
            border-radius: 4px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            z-index: 1;
        }
        .section {
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        .section-title {
            font-weight: bold;
            margin-bottom: 5px;
            color: #333;
        }
        button {
            display: block;
            margin: 5px 0;
            padding: 8px 16px;
            cursor: pointer;
            border: none;
            border-radius: 4px;
            background: #4a90e2;
            color: white;
            transition: background 0.3s;
            width: 100%;
        }
        button:hover {
            background: #357abd;
        }
        .mapboxgl-popup {
            max-width: 200px;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div class="control-panel">
        <div class="section">
            <div class="section-title">3D Objects</div>
            <button onclick="addSphere()">Add Sphere</button>
            <button onclick="addBox()">Add Box</button>
            <button onclick="addLine()">Add Line</button>
            <button onclick="addTube()">Add Tube</button>
            <button onclick="clearObjects()">Clear Objects</button>
        </div>
        <div class="section">
            <div class="section-title">Mapbox Features</div>
            <button onclick="addMarker()">Add Marker</button>
            <button onclick="addPopup()">Add Popup</button>
            <button onclick="addGeoJSONLayer()">Add GeoJSON Layer</button>
            <button onclick="toggleHeatmap()">Toggle Heatmap</button>
        </div>
        <div class="section">
            <div class="section-title">Three.js Features</div>
            <button onclick="addCustomGeometry()">Add Custom Geometry</button>
            <button onclick="addPointLight()">Add Point Light</button>
            <button onclick="toggleWireframe()">Toggle Wireframe</button>
        </div>
        <div class="section">
            <div class="section-title">Controls</div>
            <button onclick="toggleTerrain()">Toggle Terrain</button>
            <button onclick="changeCamera()">Change Camera</button>
        </div>
    </div>

    <script type="module">
        import { MapboxThree } from '../src/core/index.ts';
        import * as THREE from 'three';

        let mapboxThree;
        let terrainEnabled = false;
        const objects = [];
        const markers = [];
        let heatmapLayer = null;

        // Initialize MapboxThree
        mapboxThree = new MapboxThree({
            mapboxConfig: {
                container: 'map',
                style: 'mapbox://styles/mapbox/dark-v11',
                accessToken: 'pk.eyJ1IjoiYmVzdHljdyIsImEiOiJja3Y2YW5icnQxaTltMnBsMGR2c2FmaDZmIn0.bYZIK1mPso12DuyirxXjVw',
                center: [-74.5, 40],
                zoom: 9,
                pitch: 60,
                bearing: 30,
                antialias: true,
                terrain: {
                    source: 'mapbox://mapbox.mapbox-terrain-dem-v1',
                    exaggeration: 1.5
                }
            },
            defaultLights: true,
            passiveRendering: true,
            onLoad: () => {
                console.log('MapboxThree initialized successfully');
                setupMapboxFeatures();
            },
            onError: (error) => {
                console.error('MapboxThree error:', error);
            }
        });

        // Get native instances
        const map = mapboxThree.getMap();
        const scene = mapboxThree.scene;
        const camera = mapboxThree.camera;

        // Mapbox native features
        function setupMapboxFeatures() {
            // Add navigation control
            map.addControl(new mapboxgl.NavigationControl());
            
            // Add scale control
            map.addControl(new mapboxgl.ScaleControl());

            // Add geolocation control
            map.addControl(new mapboxgl.GeolocateControl({
                positionOptions: { enableHighAccuracy: true },
                trackUserLocation: true
            }));
        }

        window.addMarker = () => {
            const marker = new mapboxgl.Marker({
                color: '#FF0000',
                draggable: true
            })
            .setLngLat([-74.5, 40])
            .addTo(map);
            
            markers.push(marker);
        };

        window.addPopup = () => {
            new mapboxgl.Popup()
                .setLngLat([-74.5, 40])
                .setHTML('<h3>Hello World!</h3><p>This is a Mapbox popup.</p>')
                .addTo(map);
        };

        window.addGeoJSONLayer = () => {
            if (!map.getSource('points')) {
                map.addSource('points', {
                    'type': 'geojson',
                    'data': {
                        'type': 'FeatureCollection',
                        'features': [
                            {
                                'type': 'Feature',
                                'geometry': {
                                    'type': 'Point',
                                    'coordinates': [-74.5, 40]
                                },
                                'properties': {
                                    'title': 'Point 1',
                                    'value': 100
                                }
                            }
                            // Add more points as needed
                        ]
                    }
                });

                map.addLayer({
                    'id': 'points-layer',
                    'type': 'circle',
                    'source': 'points',
                    'paint': {
                        'circle-radius': 8,
                        'circle-color': '#FF0000'
                    }
                });
            }
        };

        window.toggleHeatmap = () => {
            if (!heatmapLayer) {
                map.addLayer({
                    'id': 'heatmap',
                    'type': 'heatmap',
                    'source': 'points',
                    'paint': {
                        'heatmap-weight': ['get', 'value'],
                        'heatmap-intensity': 0.5,
                        'heatmap-color': [
                            'interpolate',
                            ['linear'],
                            ['heatmap-density'],
                            0, 'rgba(0,0,255,0)',
                            0.5, 'rgba(0,255,0,0.5)',
                            1, 'rgba(255,0,0,1)'
                        ]
                    }
                });
                heatmapLayer = true;
            } else {
                map.removeLayer('heatmap');
                heatmapLayer = null;
            }
        };

        // Three.js native features
        window.addCustomGeometry = () => {
            const geometry = new THREE.TorusKnotGeometry(100, 30, 100, 16);
            const material = new THREE.MeshStandardMaterial({
                color: 0x00ff00,
                metalness: 0.5,
                roughness: 0.5
            });
            const torusKnot = new THREE.Mesh(geometry, material);
            
            const worldPos = mapboxThree.projectToWorld([-74.5, 40], 500);
            torusKnot.position.copy(worldPos);
            
            mapboxThree.add(torusKnot);
            objects.push(torusKnot);
        };

        window.addPointLight = () => {
            const light = new THREE.PointLight(0xffffff, 1, 1000);
            const worldPos = mapboxThree.projectToWorld([-74.4, 40.1], 800);
            light.position.copy(worldPos);
            
            // Add light helper
            const sphereSize = 50;
            const pointLightHelper = new THREE.PointLightHelper(light, sphereSize);
            
            scene.add(light);
            scene.add(pointLightHelper);
            objects.push(light);
            objects.push(pointLightHelper);
        };

        window.toggleWireframe = () => {
            scene.traverse((object) => {
                if (object instanceof THREE.Mesh) {
                    object.material.wireframe = !object.material.wireframe;
                }
            });
        };

        // Basic 3D Objects
        window.addSphere = () => {
            const sphere = mapboxThree.sphere({
                coordinates: [-74.5, 40],
                radius: 200,
                color: '#ff0000',
                opacity: 0.8,
                units: 'meters',
                altitude: 500
            });
            mapboxThree.add(sphere);
            objects.push(sphere);

            // Add animation
            mapboxThree.animate(sphere, {
                'position.y': { start: sphere.position.y, end: sphere.position.y + 1000 }
            }, {
                duration: 2000,
                easing: 'easeInOutQuad',
                yoyo: true,
                repeat: -1
            });
        };

        window.addBox = () => {
            const box = mapboxThree.box({
                coordinates: [-74.6, 40.1],
                width: 300,
                height: 300,
                depth: 300,
                color: '#00ff00',
                opacity: 0.8,
                units: 'meters',
                altitude: 300
            });
            mapboxThree.add(box);
            objects.push(box);

            // Add rotation animation
            mapboxThree.animate(box, {
                'rotation.y': { start: 0, end: Math.PI * 2 }
            }, {
                duration: 3000,
                repeat: -1
            });
        };

        window.addLine = () => {
            const line = mapboxThree.line({
                path: [
                    [-74.5, 40],
                    [-74.3, 40.2],
                    [-74.7, 40.4]
                ],
                width: 10,
                color: '#0000ff',
                units: 'meters',
                altitude: 200
            });
            mapboxThree.add(line);
            objects.push(line);
        };

        window.addTube = () => {
            const tube = mapboxThree.tube({
                path: [
                    [-74.5, 40],
                    [-74.3, 40.2],
                    [-74.7, 40.4]
                ],
                radius: 50,
                color: '#ffff00',
                opacity: 0.8,
                units: 'meters',
                altitude: 400,
                segments: 64,
                radialSegments: 8
            });
            mapboxThree.add(tube);
            objects.push(tube);
        };

        window.addPointLight = () => {
            // ... rest of the code ...
        };

        window.clearObjects = () => {
            // Clear Three.js objects
            objects.forEach(obj => mapboxThree.remove(obj));
            objects.length = 0;

            // Clear Mapbox markers
            markers.forEach(marker => marker.remove());
            markers.length = 0;

            // Clear layers
            if (map.getLayer('points-layer')) {
                map.removeLayer('points-layer');
            }
            if (map.getLayer('heatmap')) {
                map.removeLayer('heatmap');
                heatmapLayer = null;
            }
            if (map.getSource('points')) {
                map.removeSource('points');
            }
        };

        // Event handling
        map.on('click', 'points-layer', (e) => {
            const coordinates = e.features[0].geometry.coordinates.slice();
            const title = e.features[0].properties.title;
            
            new mapboxgl.Popup()
                .setLngLat(coordinates)
                .setHTML(`<h3>${title}</h3>`)
                .addTo(map);
        });

        // Add click event listener for Three.js objects
        mapboxThree.addEventListener(mapboxThree.world, 'click', (event) => {
            const { object, intersection } = event;
            if (object) {
                console.log('Clicked 3D object:', {
                    object,
                    position: intersection.point,
                    distance: intersection.distance
                });
            }
        });
    </script>
</body>
</html> 