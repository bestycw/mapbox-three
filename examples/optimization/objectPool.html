<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MapboxThree - Object Pool Example</title>
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.css' rel='stylesheet' />
    <style>
        body { margin: 0; }
        #map { width: 100vw; height: 100vh; }
        #info {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px;
            border-radius: 8px;
            font-family: Arial, sans-serif;
            min-width: 200px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        #controls {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        #metrics {
            position: fixed;
            bottom: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px;
            border-radius: 8px;
            font-family: Arial, sans-serif;
            min-width: 200px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        button {
            padding: 10px 15px;
            cursor: pointer;
            border: none;
            border-radius: 4px;
            background: #4CAF50;
            color: white;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        button:hover {
            background: #45a049;
            transform: translateY(-1px);
        }
        button.active {
            background: #2196F3;
        }
        .metric {
            margin: 5px 0;
            font-size: 14px;
        }
        .metric-value {
            color: #4CAF50;
            font-weight: bold;
        }
        .metric-group {
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px solid rgba(255,255,255,0.2);
        }
        .slider-container {
            display: flex;
            align-items: center;
            gap: 10px;
            color: white;
            margin: 10px 0;
        }
        input[type="range"] {
            flex: 1;
            height: 5px;
            border-radius: 5px;
            background: #4CAF50;
            outline: none;
            -webkit-appearance: none;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 15px;
            height: 15px;
            border-radius: 50%;
            background: #fff;
            cursor: pointer;
        }
        .chart-container {
            height: 60px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 4px;
            margin-top: 10px;
            position: relative;
            overflow: hidden;
        }
        .chart-bar {
            position: absolute;
            bottom: 0;
            width: 3px;
            background: #4CAF50;
            transition: height 0.3s;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div id="info">
        <h3>Object Pool Demo</h3>
        <div class="metric">Active Particles: <span id="activeCount" class="metric-value">0</span></div>
        <div class="metric">Available in Pool: <span id="availableCount" class="metric-value">0</span></div>
        <div class="metric">Memory Usage: <span id="memoryUsage" class="metric-value">0</span> MB</div>
        <div class="metric">FPS: <span id="fps" class="metric-value">0</span></div>
        <div class="metric">Draw Calls: <span id="drawCalls" class="metric-value">0</span></div>
    </div>
    <div id="controls">
        <button id="toggleSpawn">Start Spawning</button>
        <button id="spawnBurst">Spawn Burst</button>
        <button id="clearAll">Clear All</button>
        <div class="slider-container">
            Spawn Rate: <input type="range" id="spawnRate" min="1" max="100" value="10">
            <span id="spawnRateValue">10</span>/s
        </div>
        <div class="metric-group">
            <h4 style="margin: 0 0 10px 0; color: #4CAF50">Test Scenarios</h4>
            <button class="scenario-button" data-scenario="highLoad">High Load Test</button>
            <button class="scenario-button" data-scenario="bursty">Burst Load Test</button>
            <button class="scenario-button" data-scenario="memory">Memory Stress Test</button>
        </div>
    </div>
    <div id="metrics">
        <div class="metric-group" style="margin-top: 0">
            <h4 style="margin: 0 0 10px 0; color: #4CAF50">Performance Metrics</h4>
            <div class="metric">Cache Hit Rate: <span id="hitRate" class="metric-value">0%</span></div>
            <div class="metric">Acquisition Time: <span id="acquisitionTime" class="metric-value">0ms</span></div>
            <div class="metric">Turnover Rate: <span id="turnoverRate" class="metric-value">0</span></div>
            <div class="metric">Peak Usage: <span id="peakUsage" class="metric-value">0</span></div>
        </div>
        <div class="metric-group">
            <h4 style="margin: 0 0 10px 0; color: #4CAF50">Lifecycle Stats</h4>
            <div class="metric">Average Use Count: <span id="avgUseCount" class="metric-value">0</span></div>
            <div class="metric">Average Pool Time: <span id="avgPoolTime" class="metric-value">0ms</span></div>
            <div class="metric">Oldest Object Age: <span id="oldestObject" class="metric-value">0s</span></div>
        </div>
        <div class="metric-group">
            <h4 style="margin: 0 0 10px 0; color: #4CAF50">Demand Analysis</h4>
            <div class="metric">Predicted Demand: <span id="predictedDemand" class="metric-value">0</span></div>
            <div class="metric">Prediction Accuracy: <span id="predictionAccuracy" class="metric-value">0%</span></div>
            <div class="chart-container" id="demandChart"></div>
        </div>
    </div>

    <script type="module">
        import { MapboxThree } from '../../src/core/MapboxThree.ts';
        import * as THREE from 'three';
        import { config as defaultConfig } from '../config.js';

        let mapboxThree;
        let isSpawning = false;
        let lastSpawnTime = 0;
        let lastTime = performance.now();
        let frameCount = 0;
        const particles = new Set();
        let demandHistory = [];
        const CHART_POINTS = 30;
        let optimizationManager;

        // 配置对象池
        const poolConfig = {
            enabled: true,
            maxSize: 2000,
            preloadCount: 100,
            autoExpand: true,
            cleanupInterval: 5000,
            predictiveScaling: true,
            minIdleTime: 10000,
            maxIdleTime: 30000,
            warmupCount: 200
        };

        const config = {
            mapbox: {
                container: 'map',
                style: 'mapbox://styles/mapbox/dark-v11',
                accessToken: defaultConfig.accessToken,
                center: [-74.5, 40],
                zoom: 15,
                pitch: 45,
                bearing: 0
            },
            three: {
                renderer: {
                    antialias: true,
                    alpha: true
                },
                lights: {
                    ambient: {
                        enabled: true,
                        color: '#ffffff',
                        intensity: 0.5
                    },
                    directional: {
                        enabled: true,
                        color: '#ffffff',
                        intensity: 1.0,
                        position: new THREE.Vector3(1, 1, 1)
                    }
                },
                autoRender: true
            },
            optimization: {
                objectPool: poolConfig
            }
        };

        async function init() {
            mapboxThree = new MapboxThree(config);
            await mapboxThree.init();
            optimizationManager = mapboxThree.getOptimizationManager();
            setupEventListeners();
            setupDemandChart();
            startPerformanceMonitoring();
            animate();
        }

        function startPerformanceMonitoring() {
            const performanceMonitor = optimizationManager.performanceMonitor;
            
            setInterval(() => {
                const metrics = performanceMonitor.getMetrics();
                const report = optimizationManager.getPerformanceReport();
                
                // 更新FPS
                document.getElementById('fps').textContent = Math.round(metrics.performance.fps || 0);
                
                // 更新绘制调用次数
                document.getElementById('drawCalls').textContent = metrics.performance.drawCalls || 0;
            }, 1000);
        }

        // 创建粒子
        function createParticle() {
            const objectPoolStrategy = optimizationManager.getStrategy('objectPool');
            return objectPoolStrategy?.acquire(
                'particle',
                () => {
                    const geometry = new THREE.SphereGeometry(5, 8, 8);
                    const material = new THREE.MeshPhongMaterial({
                        color: new THREE.Color().setHSL(Math.random(), 1, 0.5),
                        transparent: true,
                        opacity: 0.8
                    });
                    return new THREE.Mesh(geometry, material);
                },
                (particle) => {
                    particle.visible = true;
                    particle.material.opacity = 0.8;
                    
                    // 随机位置和运动参数
                    const lat = 40 + (Math.random() - 0.5) * 0.05;
                    const lng = -74.5 + (Math.random() - 0.5) * 0.05;
                    const height = 50 + Math.random() * 300;

                    particle.userData.velocity = new THREE.Vector3(
                        (Math.random() - 0.5) * 4,
                        Math.random() * 4,
                        (Math.random() - 0.5) * 4
                    );
                    particle.userData.lifetime = 3 + Math.random() * 2;
                    particle.userData.age = 0;
                    particle.userData.rotationSpeed = new THREE.Vector3(
                        Math.random() * 2,
                        Math.random() * 2,
                        Math.random() * 2
                    );

                    mapboxThree.add(particle, {}, {
                        coordinates: [lng, lat, height]
                    });
                }
            );
        }

        function spawnParticle() {
            const particle = createParticle();
            particles.add(particle);
            updateStats();
        }

        function spawnBurst(count = 100) {
            for (let i = 0; i < count; i++) {
                spawnParticle();
            }
        }

        function updateParticles(deltaTime) {
            particles.forEach(particle => {
                particle.userData.age += deltaTime;

                if (particle.userData.age >= particle.userData.lifetime) {
                    particles.delete(particle);
                    mapboxThree.remove(particle);
                    const objectPoolStrategy = optimizationManager.getStrategy('objectPool');
                    objectPoolStrategy?.release('particle', particle);
                } else {
                    const velocity = particle.userData.velocity;
                    const rotationSpeed = particle.userData.rotationSpeed;
                    const progress = particle.userData.age / particle.userData.lifetime;
                    
                    // 更新位置
                    particle.position.add(velocity.clone().multiplyScalar(deltaTime * 50));
                    
                    // 更新旋转
                    particle.rotation.x += rotationSpeed.x * deltaTime;
                    particle.rotation.y += rotationSpeed.y * deltaTime;
                    particle.rotation.z += rotationSpeed.z * deltaTime;
                    
                    // 更新缩放和透明度
                    const scale = 1 - progress * 0.5;
                    particle.scale.setScalar(scale);
                    particle.material.opacity = 0.8 * (1 - progress);
                }
            });
        }

        function updateStats() {
            const objectPoolStrategy = optimizationManager.getStrategy('objectPool');
            const stats = objectPoolStrategy?.getStats();
            const particleStats = stats?.particle;
            if (!particleStats) return;

            // 更新基本统计
            document.getElementById('activeCount').textContent = particleStats.inUse;
            document.getElementById('availableCount').textContent = particleStats.available;
            document.getElementById('memoryUsage').textContent = 
                (particleStats.metrics.memoryUsage / (1024 * 1024)).toFixed(2);

            // 更新性能指标
            document.getElementById('hitRate').textContent = 
                (particleStats.metrics.hitRate * 100).toFixed(1) + '%';
            document.getElementById('acquisitionTime').textContent = 
                particleStats.metrics.averageAcquisitionTime.toFixed(2) + 'ms';
            document.getElementById('turnoverRate').textContent = 
                particleStats.metrics.turnoverRate.toFixed(2);
            document.getElementById('peakUsage').textContent = particleStats.metrics.peakUsage;

            // 更新生命周期信息
            document.getElementById('avgUseCount').textContent = 
                particleStats.lifecycle.averageUseCount.toFixed(1);
            document.getElementById('avgPoolTime').textContent = 
                (particleStats.lifecycle.averageTimeInPool / 1000).toFixed(1) + 's';
            document.getElementById('oldestObject').textContent = 
                ((performance.now() - particleStats.lifecycle.oldestObject) / 1000).toFixed(1) + 's';

            // 更新需求图表
            updateDemandChart(particleStats.inUse);
        }

        function setupDemandChart() {
            const chart = document.getElementById('demandChart');
            for (let i = 0; i < CHART_POINTS; i++) {
                const bar = document.createElement('div');
                bar.className = 'chart-bar';
                bar.style.left = (i * (100 / CHART_POINTS)) + '%';
                chart.appendChild(bar);
            }
        }

        function updateDemandChart(currentDemand) {
            demandHistory.push(currentDemand);
            if (demandHistory.length > CHART_POINTS) {
                demandHistory.shift();
            }

            const maxDemand = Math.max(...demandHistory, 1);
            const bars = document.querySelectorAll('.chart-bar');
            
            demandHistory.forEach((demand, i) => {
                const height = (demand / maxDemand) * 100;
                bars[i].style.height = height + '%';
            });
        }

        function clearObjects() {
            const objectPoolStrategy = optimizationManager.getStrategy('objectPool');
            particles.forEach(particle => {
                mapboxThree.remove(particle);
                objectPoolStrategy?.release('particle', particle);
            });
            particles.clear();
            updateStats();
        }

        function runScenario(type) {
            const objectPoolStrategy = optimizationManager.getStrategy('objectPool');
            switch (type) {
                case 'highLoad':
                    // 高负载测试
                    isSpawning = true;
                    document.getElementById('spawnRate').value = 50;
                    document.getElementById('spawnRateValue').textContent = 50;
                    spawnBurst(500);
                    break;
                    
                case 'bursty':
                    // 突发负载测试
                    const burstInterval = setInterval(() => {
                        spawnBurst(200);
                    }, 2000);
                    setTimeout(() => clearInterval(burstInterval), 10000);
                    break;
                    
                case 'memory':
                    // 内存压力测试
                    isSpawning = true;
                    document.getElementById('spawnRate').value = 20;
                    document.getElementById('spawnRateValue').textContent = 20;
                    setInterval(() => {
                        if (particles.size > 1000) {
                            objectPoolStrategy?.optimizePools();
                        }
                    }, 1000);
                    break;
            }
        }

        function animate() {
            requestAnimationFrame(animate);
            mapboxThree.render();
            const currentTime = performance.now();
            const deltaTime = (currentTime - lastTime) / 1000;
            lastTime = currentTime;

            // 更新FPS
            frameCount++;
            if (currentTime - lastSpawnTime >= 1000) {
                document.getElementById('fps').textContent = frameCount;
                frameCount = 0;
                lastSpawnTime = currentTime;
            }

            // 根据设定的速率生成粒子
            if (isSpawning) {
                const spawnRate = parseInt(document.getElementById('spawnRate').value);
                const spawnInterval = 1 / spawnRate;
                if (currentTime - lastSpawnTime >= spawnInterval * 1000) {
                    spawnParticle();
                    lastSpawnTime = currentTime;
                }
            }

            // 更新所有粒子
            updateParticles(deltaTime);
            updateStats();

            // 定期优化
            const objectPoolStrategy = optimizationManager.getStrategy('objectPool');
            objectPoolStrategy?.optimizePools();
        }

        function setupEventListeners() {
            document.getElementById('toggleSpawn').addEventListener('click', (e) => {
                isSpawning = !isSpawning;
                e.target.textContent = isSpawning ? '停止生成' : '开始生成';
                e.target.classList.toggle('active', isSpawning);
            });

            document.getElementById('spawnBurst').addEventListener('click', () => spawnBurst(200));

            document.getElementById('clearAll').addEventListener('click', () => {
                clearObjects();
            });

            document.getElementById('spawnRate').addEventListener('input', (e) => {
                document.getElementById('spawnRateValue').textContent = e.target.value;
            });

            document.querySelectorAll('.scenario-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    runScenario(e.target.dataset.scenario);
                });
            });
        }

        init();
    </script>
</body>
</html> 