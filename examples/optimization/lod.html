<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MapboxThree - LOD Example</title>
    <!-- <script src="https://unpkg.com/three@0.158.0/build/three.js"></script> -->
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.css' rel='stylesheet' />
    <style>
        body { margin: 0; }
        #map { width: 100vw; height: 100vh; }
        #info {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(255, 255, 255, 0.8);
            padding: 10px;
            border-radius: 4px;
            font-family: Arial, sans-serif;
        }
        #controls {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.8);
            padding: 10px;
            border-radius: 4px;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        button {
            padding: 8px;
            cursor: pointer;
        }
        .active {
            background-color: #4CAF50;
            color: white;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div id="info">
        <h3>LOD (Level of Detail) Demo</h3>
        <p>Camera Distance: <span id="distance">0</span>m</p>
        <p>Current Detail Level: <span id="detail">100</span>%</p>
        <p>Vertex Count: <span id="vertices">0</span></p>
        <p>LOD Status: <span id="lodStatus">Enabled</span></p>
    </div>
    <div id="controls">
        <button id="toggleLOD">Toggle LOD</button>
        <button id="addDefaultLOD">Add Default LOD Box</button>
        <button id="addCustomLOD">Add Custom LOD Sphere</button>
        <button id="addMultiLOD">Add Multi-Geometry LOD</button>
        <button id="clearObjects">Clear All Objects</button>
    </div>

    <script type="module">
        import { MapboxThree } from '../../src/core/MapboxThree.ts';
        import * as THREE from 'three';
        import {config as defaultConfig} from '../config.js'
        let mapboxThree;
        const config = {
            mapbox: {
                container: 'map',
                style: 'mapbox://styles/mapbox/dark-v11',
                accessToken: defaultConfig.accessToken,
                center: [-74.5, 40],
                zoom: 15,
                pitch: 45,
                bearing: 0
            },
            three: {
                renderer: {
                    antialias: true,
                    alpha: true
                },
                lights: {
                    ambient: {
                        enabled: true,
                        color: '#ffffff',
                        intensity: 0.5
                    },
                    directional: {
                        enabled: true,
                        color: '#ffffff',
                        intensity: 1.0
                    }
                }
            },
            optimization: {
                //全局默认配置
                lod: {
                    enabled: true,
                    levels: [
                        { distance: 0, detail: 1 },
                        { distance: 1000, detail: 0.5 },
                        { distance: 2000, detail: 0.25 }
                    ]
                }
            }
        };

        async function init() {
            mapboxThree = new MapboxThree(config);
            await mapboxThree.init();
            setupHooks();
        }

        // 添加默认LOD盒子
        function addDefaultLOD() {
            const geometry = new THREE.BoxGeometry(200, 200, 200, 32, 32, 32);
            const material = new THREE.MeshPhongMaterial({ 
                color: '#00ff00',
                wireframe: true 
            });
            const box = new THREE.Mesh(geometry, material);
            
            const lat = 40 + (Math.random() - 0.5) * 2;
            const lng = -74.5 + (Math.random() - 0.5) * 2;
            
            mapboxThree.add(box, {}, {
                coordinates: [lng, lat, 500]
            });
        }

        // 添加自定义LOD球体
        function addCustomLOD() {
            const geometry = new THREE.SphereGeometry(200, 64, 64);
            const material = new THREE.MeshPhongMaterial({ 
                color: '#ff0000',
                wireframe: true 
            });
            const sphere = new THREE.Mesh(geometry, material);
            
            const lat = 40 + (Math.random() - 0.5) * 2;
            const lng = -74.5 + (Math.random() - 0.5) * 2;
            
            mapboxThree.add(sphere, {}, {
                coordinates: [lng, lat, 500],
                lod: {
                    lodLevels: [
                        { distance: 0, detail: 1 },
                        { distance: 1000, detail: 0.6 },
                        { distance: 2000, detail: 0.3 },
                        { distance: 3000, detail: 0.1 }
                    ]
                }
            });
        }

        // 添加多几何体LOD
        function addMultiLOD() {
            // 高细节几何体
            const highDetail = new THREE.TorusKnotGeometry(100, 30, 128, 32);
            const mediumDetail = new THREE.TorusKnotGeometry(100, 30, 64, 16);
            const lowDetail = new THREE.TorusKnotGeometry(100, 30, 32, 8);
            
            const material = new THREE.MeshPhongMaterial({ 
                color: '#ff0000',
                wireframe: true 
            });
            
            const highMesh = new THREE.Mesh(highDetail, material);
            const mediumMesh = new THREE.Mesh(mediumDetail, material);
            const lowMesh = new THREE.Mesh(lowDetail, material);
            
            const lat = 40 + (Math.random() - 0.5) * 2;
            const lng = -74.5 + (Math.random() - 0.5) * 2;
            
            mapboxThree.add(highMesh, {}, {
                coordinates: [lng, lat, 500],
                lod: {
                    lodLevels: [
                        { distance: 0, detail: highMesh },
                        { distance: 1000, detail: mediumMesh },
                        { distance: 2000, detail: lowMesh }
                    ]
                }
            });
        }

        // 清除所有对象
        function clearObjects() {
            mapboxThree.world.children.slice().forEach(child => {
                mapboxThree.remove(child);
            });
        }

        // 设置LOD钩子以更新UI
        function setupHooks() {
            const lodManager = mapboxThree.getOptimizationManager().getLODManager();
            lodManager.setHooks(
                (object, distance) => {
                    document.getElementById('distance').textContent = Math.round(distance);
                },
                (object) => {
                    if (object instanceof THREE.LOD) {
                        const currentLevel = object.getCurrentLevel();
                        if (currentLevel !== -1) {
                            const currentObject = object.getObjectForDistance(currentLevel);
                            if (currentObject instanceof THREE.Mesh) {
                                const vertexCount = currentObject.geometry.getAttribute('position').count;
                                document.getElementById('vertices').textContent = vertexCount;
                                const maxVertices = object.levels[0].object.geometry.getAttribute('position').count;
                                const detail = Math.round((vertexCount / maxVertices) * 100);
                                document.getElementById('detail').textContent = detail;
                            }
                        }
                    }
                }
            );
        }

        // 切换LOD功能
        function toggleLOD() {
            const lodManager = mapboxThree.getOptimizationManager().getLODManager();
            const config = lodManager.getConfig();
            const enabled = !config.enabled;
            lodManager.setEnabled(enabled);
            document.getElementById('lodStatus').textContent = enabled ? 'Enabled' : 'Disabled';
            document.getElementById('toggleLOD').classList.toggle('active', enabled);
        }

        // 添加事件监听器
        document.getElementById('toggleLOD').addEventListener('click', toggleLOD);
        document.getElementById('addDefaultLOD').addEventListener('click', addDefaultLOD);
        document.getElementById('addCustomLOD').addEventListener('click', addCustomLOD);
        document.getElementById('addMultiLOD').addEventListener('click', addMultiLOD);
        document.getElementById('clearObjects').addEventListener('click', clearObjects);

        // 启动应用
        init();
    </script>
</body>
</html>
