<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MapboxThree - LOD Example</title>
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.css' rel='stylesheet' />
    <style>
        body { margin: 0; }
        #map { width: 100vw; height: 100vh; }
        #info {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px;
            border-radius: 8px;
            font-family: Arial, sans-serif;
            min-width: 200px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        #controls {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        button {
            padding: 10px 15px;
            cursor: pointer;
            border: none;
            border-radius: 4px;
            background: #4CAF50;
            color: white;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        button:hover {
            background: #45a049;
            transform: translateY(-1px);
        }
        button.active {
            background: #2196F3;
        }
        .metric {
            margin: 5px 0;
            font-size: 14px;
        }
        .metric-value {
            color: #4CAF50;
            font-weight: bold;
        }
        #performance {
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px solid rgba(255,255,255,0.2);
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div id="info">
        <h3>LOD (Level of Detail) Demo</h3>
        <div class="metric">Camera Distance: <span id="distance" class="metric-value">0</span>m</div>
        <div class="metric">Current Detail Level: <span id="detail" class="metric-value">100</span>%</div>
        <div class="metric">Vertex Count: <span id="vertices" class="metric-value">0</span></div>
        <div class="metric">LOD Status: <span id="lodStatus" class="metric-value">Enabled</span></div>
        <div id="performance">
            <h4>Performance Metrics</h4>
            <div class="metric">FPS: <span id="fps" class="metric-value">0</span></div>
            <div class="metric">Draw Calls: <span id="drawCalls" class="metric-value">0</span></div>
            <div class="metric">Memory Usage: <span id="memory" class="metric-value">0</span> MB</div>
        </div>
    </div>
    <div id="controls">
        <button id="toggleLOD">Toggle LOD</button>
        <button id="addDefaultLOD">Add Default LOD Box</button>
        <button id="addCustomLOD">Add Custom LOD Sphere</button>
        <button id="addMultiLOD">Add Multi-Geometry LOD</button>
        <button id="clearObjects">Clear All Objects</button>
    </div>

    <script type="module">
        import { MapboxThree } from '../../src/core/MapboxThree.ts';
        import * as THREE from 'three';
        import {config as defaultConfig} from '../config.js';

        let mapboxThree;
        const config = {
            mapbox: {
                container: 'map',
                style: 'mapbox://styles/mapbox/dark-v11',
                accessToken: defaultConfig.accessToken,
                center: [-74.5, 40],
                zoom: 15,
                pitch: 45,
                bearing: 0
            },
            three: {
                renderer: {
                    antialias: true,
                    alpha: true
                },
                lights: {
                    ambient: {
                        enabled: true,
                        color: '#ffffff',
                        intensity: 0.5
                    },
                    directional: {
                        enabled: true,
                        color: '#ffffff',
                        intensity: 1.0,
                        position: new THREE.Vector3(1, 1, 1)
                    }
                },
                autoRender: true
            },
            optimization: {
                lod: {
                    enabled: true,
                    levels: [
                        { distance: 0, detail: 1 },
                        { distance: 1000, detail: 0.5 },
                        { distance: 2000, detail: 0.25 },
                        { distance: 3000, detail: 0.1 }
                    ],
                    dynamicAdjustment: true,
                    performanceTarget: 60
                }
            }
        };

        async function init() {
            mapboxThree = new MapboxThree(config);
            await mapboxThree.init();
            setupHooks();
            startPerformanceMonitoring();
        }

        // 添加默认LOD盒子
        function addDefaultLOD() {
            const geometry = new THREE.BoxGeometry(200, 200, 200, 64, 64, 64);
            const material = new THREE.MeshPhongMaterial({ 
                color: new THREE.Color(Math.random(), Math.random(), Math.random()),
                wireframe: true 
            });
            const box = new THREE.Mesh(geometry, material);
            
            const lat = 40 + (Math.random() - 0.5) * 0.1;
            const lng = -74.5 + (Math.random() - 0.5) * 0.1;
            
            mapboxThree.add(box, {}, {
                coordinates: [lng, lat, 500]
            });
        }

        // 添加自定义LOD球体
        function addCustomLOD() {
            const geometry = new THREE.SphereGeometry(200, 128, 128);
            const material = new THREE.MeshPhongMaterial({ 
                color: new THREE.Color(Math.random(), Math.random(), Math.random()),
                wireframe: true 
            });
            const sphere = new THREE.Mesh(geometry, material);
            
            const lat = 40 + (Math.random() - 0.5) * 0.1;
            const lng = -74.5 + (Math.random() - 0.5) * 0.1;
            
            mapboxThree.add(sphere, {}, {
                coordinates: [lng, lat, 500],
                lod: {
                    lodLevels: [
                        { distance: 0, detail: 1 },
                        { distance: 800, detail: 0.75 },
                        { distance: 1500, detail: 0.5 },
                        { distance: 2500, detail: 0.25 },
                        { distance: 3500, detail: 0.1 }
                    ]
                }
            });
        }

        // 添加多几何体LOD
        function addMultiLOD() {
            const highDetail = new THREE.TorusKnotGeometry(150, 40, 256, 64);
            const mediumDetail = new THREE.TorusKnotGeometry(150, 40, 128, 32);
            const lowDetail = new THREE.TorusKnotGeometry(150, 40, 64, 16);
            const veryLowDetail = new THREE.TorusKnotGeometry(150, 40, 32, 8);
            
            const material = new THREE.MeshPhongMaterial({ 
                color: new THREE.Color(Math.random(), Math.random(), Math.random()),
                wireframe: true 
            });
            
            const highMesh = new THREE.Mesh(highDetail, material.clone());
            const mediumMesh = new THREE.Mesh(mediumDetail, material.clone());
            const lowMesh = new THREE.Mesh(lowDetail, material.clone());
            const veryLowMesh = new THREE.Mesh(veryLowDetail, material.clone());
            
            const lat = 40 + (Math.random() - 0.5) * 0.1;
            const lng = -74.5 + (Math.random() - 0.5) * 0.1;
            
            mapboxThree.add(highMesh, {}, {
                coordinates: [lng, lat, 500],
                lod: {
                    lodLevels: [
                        { distance: 0, detail: highMesh },
                        { distance: 1000, detail: mediumMesh },
                        { distance: 2000, detail: lowMesh },
                        { distance: 3000, detail: veryLowMesh }
                    ]
                }
            });
        }

        // 清除所有对象
        function clearObjects() {
            const objects = [...mapboxThree.world.children];
            objects.forEach(obj => mapboxThree.remove(obj));
        }

        // 设置LOD钩子以更新UI
        function setupHooks() {
            const lodManager = mapboxThree.getOptimizationManager().getStrategy('lod');
            if (!lodManager) return;

            lodManager.setHooks(
                (object, distance) => {
                    document.getElementById('distance').textContent = Math.round(distance);
                },
                (object) => {
                    if (object instanceof THREE.LOD) {
                        const currentLevel = object.getCurrentLevel();
                        if (currentLevel !== -1) {
                            const currentObject = object.getObjectForDistance(currentLevel);
                            if (currentObject instanceof THREE.Mesh) {
                                const vertexCount = currentObject.geometry.getAttribute('position').count;
                                document.getElementById('vertices').textContent = vertexCount.toLocaleString();
                                const maxVertices = object.levels[0].object.geometry.getAttribute('position').count;
                                const detail = Math.round((vertexCount / maxVertices) * 100);
                                document.getElementById('detail').textContent = detail;
                            }
                        }
                    }
                }
            );
        }

        // 切换LOD功能
        function toggleLOD() {
            const lodManager = mapboxThree.getOptimizationManager().getStrategy('lod');
            if (!lodManager) return;

            const config = lodManager.getConfig();
            const enabled = !config.enabled;
            lodManager.setEnabled(enabled);
            document.getElementById('lodStatus').textContent = enabled ? 'Enabled' : 'Disabled';
            document.getElementById('toggleLOD').classList.toggle('active', enabled);
        }

        // 性能监控
        function startPerformanceMonitoring() {
            const performanceMonitor = mapboxThree.getOptimizationManager().performanceMonitor;
            
            setInterval(() => {
                const metrics = performanceMonitor.getMetrics();
                const report = mapboxThree.getOptimizationManager().getPerformanceReport();
                
                // 更新FPS
                document.getElementById('fps').textContent = Math.round(metrics.performance.fps || 0);
                
                // 更新绘制调用次数
                document.getElementById('drawCalls').textContent = metrics.performance.drawCalls || 0;
                
                // 更新内存使用情况
                let totalMemory = 0;
                
                // 累加所有策略的内存使用
                Object.values(report.strategies).forEach(strategyMetrics => {
                    if (strategyMetrics && typeof strategyMetrics.memoryUsage === 'number') {
                        totalMemory += strategyMetrics.memoryUsage;
                    }
                });
                
                // 转换为MB并保留2位小数
                const memoryInMB = (totalMemory / (1024 * 1024)).toFixed(2);
                document.getElementById('memory').textContent = memoryInMB;
            }, 1000);
        }

        // 添加事件监听器
        document.getElementById('toggleLOD').addEventListener('click', toggleLOD);
        document.getElementById('addDefaultLOD').addEventListener('click', addDefaultLOD);
        document.getElementById('addCustomLOD').addEventListener('click', addCustomLOD);
        document.getElementById('addMultiLOD').addEventListener('click', addMultiLOD);
        document.getElementById('clearObjects').addEventListener('click', clearObjects);

        // 启动应用
        init();
    </script>
</body>
</html>
