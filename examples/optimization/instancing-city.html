<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MapboxThree - City Instancing Example</title>
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.css' rel='stylesheet' />
    <style>
        body { margin: 0; }
        #map { width: 100vw; height: 100vh; }
        .panel {
            position: fixed;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            max-width: 400px;
        }
        #info {
            top: 10px;
            left: 10px;
        }
        #controls {
            top: 10px;
            right: 10px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        #metrics {
            bottom: 10px;
            left: 10px;
            font-size: 12px;
        }
        .metric-group {
            margin: 10px 0;
            padding: 5px;
            border-left: 3px solid #4CAF50;
        }
        .metric-title {
            color: #4CAF50;
            font-weight: bold;
        }
        .metric-value {
            margin-left: 10px;
            color: #ddd;
        }
        button {
            padding: 8px 12px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.3s;
        }
        button:hover {
            background: #45a049;
        }
        button.active {
            background: #ff5722;
        }
        .slider-container {
            display: flex;
            align-items: center;
            gap: 10px;
            color: white;
        }
        input[type="range"] {
            flex: 1;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div id="info" class="panel">
        <h3>城市实例化渲染演示</h3>
        <div class="metric-group">
            <div class="metric-title">基本统计</div>
            <div>建筑数量: <span id="buildingCount" class="metric-value">0</span></div>
            <div>实例数量: <span id="instanceCount" class="metric-value">0</span></div>
            <div>内存使用: <span id="memoryUsage" class="metric-value">0 MB</span></div>
            <div>FPS: <span id="fps" class="metric-value">0</span></div>
        </div>
    </div>
    <div id="controls" class="panel">
        <div>
            <button id="toggleAnimation">开始动画</button>
            <button id="regenerate">重新生成</button>
            <button id="clearAll">清除全部</button>
        </div>
        <div class="slider-container">
            建筑密度: <input type="range" id="densitySlider" min="1" max="10" value="5" step="1">
            <span id="densityValue">5</span>
        </div>
        <div class="slider-container">
            建筑高度: <input type="range" id="heightSlider" min="50" max="500" value="200" step="10">
            <span id="heightValue">200</span>m
        </div>
        <div class="metric-group">
            <div class="metric-title">性能指标</div>
            <div>绘制调用: <span id="drawCalls" class="metric-value">0</span></div>
            <div>更新时间: <span id="updateTime" class="metric-value">0ms</span></div>
        </div>
    </div>

    <script type="module">
        import { MapboxThree } from '../../src/core/MapboxThree.ts';
        import * as THREE from 'three';
        import { config as defaultConfig } from '../config.js';

        let mapboxThree;
        let isAnimating = false;
        let lastTime = performance.now();
        let frameCount = 0;
        const buildings = new Set();
        const buildingTypes = new Map();

        // 配置实例化
        const instanceConfig = {
            enabled: true,
            threshold: 10,
            maxInstanceCount: 10000,
            batchSize: 1000,
            dynamicBatching: true,
            updateInterval: 16
        };

        const config = {
            mapbox: {
                container: 'map',
                style: 'mapbox://styles/mapbox/dark-v11',
                accessToken: defaultConfig.accessToken,
                center: [-74.0, 40.7],
                zoom: 16,
                pitch: 60,
                bearing: -30
            },
            optimization: {
                instancing: instanceConfig
            }
        };

        // 建筑类型定义
        const BUILDING_TYPES = [
            {
                name: 'skyscraper',
                geometry: new THREE.BoxGeometry(20, 1, 20),
                material: new THREE.MeshPhongMaterial({
                    color: 0x4488ff,
                    transparent: true,
                    opacity: 0.9
                }),
                minHeight: 100,
                maxHeight: 400
            },
            {
                name: 'office',
                geometry: new THREE.BoxGeometry(30, 1, 30),
                material: new THREE.MeshPhongMaterial({
                    color: 0x44ff88,
                    transparent: true,
                    opacity: 0.9
                }),
                minHeight: 50,
                maxHeight: 200
            },
            {
                name: 'residential',
                geometry: new THREE.BoxGeometry(25, 1, 25),
                material: new THREE.MeshPhongMaterial({
                    color: 0xff8844,
                    transparent: true,
                    opacity: 0.9
                }),
                minHeight: 30,
                maxHeight: 150
            }
        ];

        async function init() {
            mapboxThree = new MapboxThree(config);
            await mapboxThree.init();
            setupEventListeners();
            generateCity();
            animate();
        }

        function createBuildingTemplate(type) {
            const template = buildingTypes.get(type);
            if (template) return template;

            const buildingType = BUILDING_TYPES.find(b => b.name === type);
            if (!buildingType) return null;

            const mesh = new THREE.Mesh(buildingType.geometry, buildingType.material);
            buildingTypes.set(type, mesh);
            return mesh;
        }

        function createBuilding(position, type, height) {
            const template = createBuildingTemplate(type);
            if (!template) return null;

            const building = template.clone();
            building.scale.y = height;
            building.position.copy(position);
            building.position.y = height / 2;

            const instancedMesh = mapboxThree.getOptimizationManager().addInstance(
                building,
                type,
                {
                    initialCount: 100,
                    dynamicBatching: true,
                    frustumCulled: true,
                    castShadow: true,
                    receiveShadow: true
                }
            );

            if (instancedMesh) {
                buildings.add(building);
                if (!mapboxThree.world.getObjectByName(type)) {
                    mapboxThree.add(instancedMesh);
                }
            }

            return building;
        }

        function generateCity() {
            clearAll();

            const density = parseInt(document.getElementById('densitySlider').value);
            const maxHeight = parseInt(document.getElementById('heightSlider').value);
            const gridSize = 20 * density;
            const spacing = 50;
            const center = new THREE.Vector3(0, 0, 0);

            for (let x = -gridSize; x <= gridSize; x += spacing) {
                for (let z = -gridSize; z <= gridSize; z += spacing) {
                    // 添加随机偏移
                    const offsetX = (Math.random() - 0.5) * spacing * 0.5;
                    const offsetZ = (Math.random() - 0.5) * spacing * 0.5;
                    const position = new THREE.Vector3(x + offsetX, 0, z + offsetZ);

                    // 根据到中心的距离调整建筑高度
                    const distanceToCenter = position.distanceTo(center);
                    const heightFactor = 1 - (distanceToCenter / (gridSize * 1.5));
                    const height = Math.max(30, maxHeight * heightFactor * (0.5 + Math.random() * 0.5));

                    // 根据位置和高度选择建筑类型
                    let type;
                    if (height > maxHeight * 0.7) {
                        type = 'skyscraper';
                    } else if (height > maxHeight * 0.4) {
                        type = 'office';
                    } else {
                        type = 'residential';
                    }

                    createBuilding(position, type, height);
                }
            }

            updateStats();
        }

        function updateBuildings(deltaTime) {
            if (!isAnimating) return;

            buildings.forEach(building => {
                // 添加简单的动画效果
                const time = performance.now() * 0.001;
                const distance = building.position.length();
                const wave = Math.sin(time + distance * 0.02) * 0.1;
                
                building.scale.y *= 1 + wave;
                building.position.y = building.scale.y / 2;

                // 更新实例
                const type = building.userData.type || 'skyscraper';
                mapboxThree.getOptimizationManager().updateInstance(building, type);
            });
        }

        function updateStats() {
            const metrics = mapboxThree.getOptimizationManager().getInstanceManager().getMetrics();
            
            document.getElementById('buildingCount').textContent = buildings.size;
            document.getElementById('instanceCount').textContent = metrics.instanceCount;
            document.getElementById('memoryUsage').textContent = 
                (metrics.memoryUsage / (1024 * 1024)).toFixed(2);
            document.getElementById('drawCalls').textContent = metrics.drawCalls;
            document.getElementById('updateTime').textContent = 
                metrics.updateTime.toFixed(2);
        }

        function animate() {
            requestAnimationFrame(animate);
            
            const currentTime = performance.now();
            const deltaTime = (currentTime - lastTime) / 1000;
            lastTime = currentTime;

            // 更新FPS
            frameCount++;
            if (currentTime - lastTime >= 1000) {
                document.getElementById('fps').textContent = frameCount;
                frameCount = 0;
            }

            // 更新建筑
            updateBuildings(deltaTime);
            updateStats();

            // 渲染场景
            mapboxThree.render();
        }

        function clearAll() {
            buildings.forEach(building => {
                const type = building.userData.type || 'skyscraper';
                mapboxThree.getOptimizationManager().removeInstance(building, type);
            });
            buildings.clear();
            updateStats();
        }

        function setupEventListeners() {
            document.getElementById('toggleAnimation').addEventListener('click', (e) => {
                isAnimating = !isAnimating;
                e.target.textContent = isAnimating ? '停止动画' : '开始动画';
                e.target.classList.toggle('active', isAnimating);
            });

            document.getElementById('regenerate').addEventListener('click', generateCity);
            document.getElementById('clearAll').addEventListener('click', clearAll);

            document.getElementById('densitySlider').addEventListener('input', (e) => {
                document.getElementById('densityValue').textContent = e.target.value;
            });

            document.getElementById('heightSlider').addEventListener('input', (e) => {
                document.getElementById('heightValue').textContent = e.target.value;
            });
        }

        init();
    </script>
</body>
</html> 